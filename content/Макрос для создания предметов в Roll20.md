Тут мои размышления и находки, которые появились в процессе создания макроса для крафта предметов. Миша ввёл новые правила крафта, я пытаюсь упростить расчёты.
# Текущие проблемы
Есть ряд проблем в разработке макроса. Для нормальной работы логики и для доступа к значениям бросков нужен доступ к API. Иначе приходится использовать лютейшие костыли. Я уж не говорю про странности парсера, из-за чего придётся заменить часть символов во вложенных макросах на их HTML-сущности.
## Повторное использование значений бросков
В моём случае нет возможности переиспользовать значение стоимости предмета. Это ломает логику работы макроса. Если использовать конструкцию $[[]], то можно вытащить результат. Но с ним нельзя проводить какие-либо математические операции. Я нашёл несколько возможных решений.
### Что надо получить 
Мне нужно в итоге получить таблицу, в которой будут следующие значения, зависящие друг от друга.

| Шапка                      | Шапка                                                                                                                            |
| -------------------------- | -------------------------------------------------------------------------------------------------------------------------------- |
| Имя                        | Вводится руками в макросе при его запуске                                                                                        |
| Стоимость предмета         | Считается по формуле, зависит от параметров предмета                                                                             |
| Характеристики предмета    | Может быть несколько строк, так как у разных предметов разные характеристики. Легко вытащить эти значения через повторный запрос |
| Затраты на крафт           | Самое сложное. Нужно посчитать затраты в золоте на сырьё и прибавить стоимость заготовки в золоте                                |
| Время на создание предмета | Считается от стоимости предмета, уровня рабочего места и бонуса инструментов. Здесь же учитывается бонус от заготовки.           |
| Уровень рабочего места     | Вытаскивается из предыдущей формулы                                                                                              |

В макросе есть числовые значения, которые ссылаются друг на друга:
* стоимость предмета, от неё считается всё остальное;
* стоимость заготовки. Её бонус в золоте равен х% от заготовки (20-70), а стоимость половине этого бонуса;
* стоимость сырья. Она считается как половина стоимости предмета - бонус в золоте от заготовки; 
* затраты на крафт, которые равны стоимости сырья + стоимость заготовки.
Нужно переиспользовать стоимость предмета как минимум три раза. Хер его знает, как это провернуть.
### Пути решения
Всё очень сложно. Но вот, что я накопал.
* Во-первых, нужно будет делать хитрые броски до строк в шаблоне. То есть делать inline roll до первых {{}} с данными. Они не будут отображаться в итоговом шаблоне.
* По идее из них можно будет вытащить данные для других полей через тот же индекс. Их не нужно обсчитывать, так что тут всё нормально. Надо проверить.
* Можно вытащить результат броска в виде числа через индекс. Вот тут чел пишет [о такой возможности](https://app.roll20.net/forum/post/10690257/reusing-rolls-pair-matter-and-math-seems-to-possible). Мне нужно будет совершать операции  над $\[\[0]] до самого совершения броска. Если это прокатит, можно посчитать половину стоимости предмета, что мне и нужно. 
- Но как прибавить к этому стоимость заготовки? Там же чувак оборачивает всё в ещё одни \[]. Надо попробовать.
- Ещё есть вариант с каким-то муторным способом через ссылки вида \[0](#). Радужный чел описывает это [вот здесь](https://app.roll20.net/forum/post/10693202/macro-curiosities-or-how-to-overcomplicate-everything/?pageforid=10693212#post-10693212). Хер его знает, как это работает. Он там же описывает, как дублировать результат броска и работать с ним. Сплошная теория без практики.
## Логические операторы
Без доступа к API нельзя использовать нормальную человекочитаемую логику. Мне нужно это для расчёта стоимости сырья. При бонусе заготовки х% больше 50, число улетает в отрицательное значение. Для избегания этого надо занулять его. 

Есть пара идей, как это сделать.
- С помощью магии математики Радужному чуваку удалось сделать нормальный If/then. Вот [ссылка на эту страницу](https://wiki.roll20.net/Useful_Macros#Conditional_Statements_.28Math_Only.29).
- Я подумал, что можно попробовать провернуть трюк с двойным отрицательным числом. Если число уходит в минус, результат будет 0. [Ссылка на этот пост](https://app.roll20.net/forum/post/10693202/macro-curiosities-or-how-to-overcomplicate-everything/?pageforid=10693203#post-10693203).
С первым вариантом могут быть сложности, так как там внутри придётся делать ссылки на броски. Это гораздо сложнее контролировать в процессе отладки из-за обилия синтаксиса. Но этот вариант более универсален. Второй же требует меньших затрат, однако работает только для одного случая, который совпадает с моей проблемой. Попробую его.
## Вложенные запросы
Парсер Roll20 работает очень странно. Он останавливается сразу же, если во вложенном запросе/макросе есть символы } | ,. Для обхода этой проблемы нужно заменить символы на их HTML-сущности. Вот [статья про это](https://wiki.roll20.net/Roll_Query). Я проверял, оно работает нормально. При повышении глубины вложенности нужно менять амперсанд на его HTML-сущность, больше глубина - больше замен.
# Другой путь
Если не получится провернуть трюк с переиспользованием значений бросков, тогда придётся сделать по-иному. Я создам отдельный макрос для расчёта стоимости предмета. Он будет включать в себя подмакросы для каждого типа предмета. При запуске будет выводиться меню в чате с выбором типа предмета.
Второй макрос будет считать затраты на крафт. Он универсален и уже работает, кстати. Стоимость нужно вводить руками. Затраты золота он считать не может всё по той же причине.
Для затрат в золоте можно сделать третий макрос, который будет их считать. Формула простейшая, поэтому проблем возникнуть не должно. Единственное, что опять придётся вводить стоимость предмета и выбирать тип заготовки.

# Формулы крафта
Если с формулами расчёта стоимости предметов всё понятно, то вот с расчётом затрат на крафт всё сложно.
## Парадоксальная стоимость
Базовая формула крафта предполагает, что создание предмета потратит: 
`затраты=сырьё в размере 0,5 от стоимости + время на крафт`
Я исходил из той же формулы при расчёте затрат в золоте. Однако у нас есть заготовки разного качества, которые ускоряют процесс создания и покрывают часть стоимости сырья. Мишей было озвучено, что сами заготовки при этом стоят половину суммы, которую они покрывают. На основе всего этого я сделал такую формулу расчёта затрат в золоте:
`затраты=стоимость предмета*0,5[сырьё]-стоимость предмета*(бонус заготовки/100)[сумма, которую покрывает заготовка]+стоимость предмета*(бонус заготовки/100)/2[стоимость заготовки]`
При бонусе заготовки свыше 0,5 стоимости предмета считается, что другое сырьё собирать не нужно. Если упростить формулу, то получится вот это:
`затраты=0,5*стоимость предмета*(1-бонус заготовки/100)`
Если подставить числа, то получается парадоксальная вещь - стоимость крафта падает вместе с ростом качества заготовки. То есть самый дорогой по деньгам крафт выходит без заготовки вообще, к тому же он и самый долгий.
Необходимо как-то решить эту проблему. Очевидно, что должна действовать логика "дороже заготовка - быстрее крафт", а не наоборот. Так же очевидно, что заготовки не могут стоить слишком дорого, но и не слишком дёшево.
## Мои мысли на этот счёт
Я вижу несколько вариантов решения этой проблемы.
Можно увеличить стоимость заготовок. Если сделать их стоимость равной сумме, которую они покрывают, то логика крафта будет работать. Тогда формула будет иметь очень простой вид:
`затраты=стоимость*0,5`
Лаконично, просто и понятно. При этом заготовки получаются по цене далеко не самыми дешёвыми, что весьма печально. Фактически у нас выходит, что они будут стоить столько же, сколько стоит такое же количество сырья в процентах, кроме случаев с мифическими и легендарными заготовками, но они компенсируют избыток стоимости особыми бонусами и сильно ускоренным временем крафта.
Другой путь - это пересмотреть базовую формулу, изменив количество сырья. Я думаю, стоит взять некое базовое число, которое будет потом домножаться на бонус заготовки (или прибавляться) в изменённом виде - в виде функции от бонуса. Само базовое число стоить взять меньше 0,5. Надо попробовать подобрать вариант, где без заготовки будет 0,3 от стоимости, а при заготовке с бонусом 50% будет подходить к 0,5 стоимости. Более дорогие заготовки будут стоить дороже половины как и до этого. Либо стоит пересмотреть и этот вариант - сделать стоимости для последних уровней качества частью формулы. Однако Мастер говорил про то, что они дают дополнительные бонусы из-за состава, поэтому и стоят дороже. Как итог имеем следующие требования к математической функции:
- у неё есть постоянная часть - она равна 0,3 (или другой коэффициент) от стоимости;
- есть часть, которая зависит от бонуса заготовки, функцию надо будет определить;
- при бонусе заготовки равном 0 переменная часть должна тоже обращаться в 0, если в формуле суммирование, либо в 1, если будет умножение;
- максимум этого выражения должен не превышать 0,5 (или 0,7) от стоимости.

# Старый код (не актуально )
Сначала я хотел сделать что-то такое.
Итоговый макрос

`/roll ?{Выберете тип предмета | Броня,#стоимость_брони |Оружие,#стоимость_оружия |Свиток,#стоимость_свитка |Зелье,#стоимость_зелья |Маг. предмет (конечный),#стоимость_неперезаряжаемого_предмета |Маг. предмет (перезаряжаемый),#стоимость_перезаряжаемого_предмета}`

Его части
#стоимость_брони

/roll ?{Базовая стоимость (из книги)&#125; + (((?{Бонус брони (сколько "+")&#124;0&#124;1&#124;2&#124;3&#124;4&#124;5&#125;+1)**2) * 2000)

/roll ?{Базовая стоимость (из книги)} + ((?{Бонус брони (сколько "+")|0|1|2|3|4|5}+1)**2) * 2000)

#стоимость_зелья

/roll ?{Уровень заклинания (0-9)&#124;Заговор, 0.1&#124;1&#124;2&#124;3&#124;4&#124;5&#124;6&#124;7&#124;8&#124;9&#125; * (?{Уровень заклинателя (1-20)&#125; ** 2) * 50

/roll ?{Уровень заклинания (0-9)|Заговор, 0.1|1|2|3|4|5|6|7|8|9} * (?{Уровень заклинателя (1-20)} ** 2) * 50

#стоимость_кд_и_спас

/roll (?{Бонус предмета (сколько +)&#124;1&#124;2&#124;3&#124;4&#124;5&#125; ** 2) * 5000

/roll (?{Бонус предмета (сколько +)|1|2|3|4|5} ** 2) * 5000

#стоимость_кд_или_спас

/roll (?{Бонус предмета (сколько +)&#124;1&#124;2&#124;3&#124;4&#124;5&#125; ** 2) * 2000

/roll (?{Бонус предмета (сколько +)|1|2|3|4|5} ** 2) * 2000

#стоимость_неперзаряжаемого_предмета

/roll ?{Уровень заклинания (0-9)&#124;Заговор, 0.1&#124;1&#124;2&#124;3&#124;4&#124;5&#124;6&#124;7&#124;8&#124;9&#125; * (?{Уровень заклинателя (1-20)&#125; ** 2) * ?{Количество зарядов в предмете&#125; * 75

/roll ?{Уровень заклинания (0-9)|Заговор, 0.1|1|2|3|4|5|6|7|8|9} * (?{Уровень заклинателя (1-20)} ** 2) * ?{Количество зарядов в предмете} * 75

#стоимость_оружия

/roll ?{Базовая стоимость (из книги)&#125; + ((?{Бонус оружия (сколько "+")&#124;0&#124;1&#124;2&#124;3&#124;4&#124;5&#125; ** 2) * 2000)

/roll ?{Базовая стоимость (из книги)} + ((?{Бонус оружия (сколько "+")|0|1|2|3|4|5} ** 2) * 2000)

#стоимость_перезаряжаемого_предмета

/roll ?{Уровень заклинания (0-9)&#124;Заговор, 0.1&#124;1&#124;2&#124;3&#124;4&#124;5&#124;6&#124;7&#124;8&#124;9&#125; * (?{Уровень заклинателя (1-20)&#125; ** 2) * ?{Количество зарядов в предмете&#125; * 250

/roll ?{Уровень заклинания (0-9)|Заговор, 0.1|1|2|3|4|5|6|7|8|9} * (?{Уровень заклинателя (1-20)} ** 2) * ?{Количество зарядов в предмете} * 250

#стоимость_свитка

/roll ?{Уровень заклинания (0-9)&#124;Заговор, 0.1&#124;1&#124;2&#124;3&#124;4&#124;5&#124;6&#124;7&#124;8&#124;9&#125; * (?{Уровень заклинателя (1-20)&#125; ** 2) * 25

/roll ?{Уровень заклинания (0-9)|Заговор, 0.1|1|2|3|4|5|6|7|8|9} * (?{Уровень заклинателя (1-20)} ** 2) * 25

Вот это макрос для расчёта стоимостей всех типов предметов. По сути всё в одном, подмакросов нет. Не подходит для вставки в текущий вариант шаблона, так как у разных типов предметов разное количество свойств. Я не знаю, можно ли вообще подстраивать шаблон на лету, меняя количество строк. Так это теперь это просто напоминание о былом.

/roll ?{Выберите тип предмета|
Броня,?{Базовая стоимость (из книги)} + ((?{Бонус брони (сколько "+"|0|1|2|3|4|5} + 1) ** 2) * 2000) |
Оружие,?{Базовая стоимость (из книги)} + ((?{Бонус оружия (сколько "+"|0|1|2|3|4|5} ** 2) * 2000) |
Свиток,?{Уровень заклинания (0-9)|Заговор, 0.1|1|2|3|4|5|6|7|8|9} * (?{Уровень заклинателя (1-20)} ** 2) * 25|
Зелье, ?{Уровень заклинания (0-9)|Заговор, 0.1|1|2|3|4|5|6|7|8|9} * (?{Уровень заклинателя (1-20)} ** 2) * 50|
Маг. предмет (конечный), ?{Уровень заклинания (0-9)|Заговор, 0.1|1|2|3|4|5|6|7|8|9} * (?{Уровень заклинателя (1-20)} ** 2) * ?{Количество зарядов в предмете} * 75|
Маг. предмет (перезаряжаемый), ?{Уровень заклинания (0-9)|Заговор, 0.1|1|2|3|4|5|6|7|8|9} * (?{Уровень заклинателя (1-20)} ** 2) * ?{Количество зарядов в предмете} * 250
}